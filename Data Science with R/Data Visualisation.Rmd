---
title: "Data Visualisation"
output: html_document
---
```{r, echo=FALSE, message=FALSE}
# Libraries
library(ggplot2)
library(dplyr)
library(here)
library(readr)
# Get the data
Cars <- read_csv(here("ZDatasets","Cars.csv"))
Diamonds <- read_csv(here("ZDatasets", "Diamonds.csv"))
msnbc <- read_csv(here("ZDatasets", "msnbc.csv"))
Hair_Eye_Colour <- read_csv(here("ZDatasets","Hair_Eye_Colour.csv"))
Youtube <- read_csv(here("ZDatasets","Youtube.csv"))
Body <- read_csv(here("ZDatasets","Body.csv"))
mpg <- read_csv(here("ZDatasets", "mpg.csv"))
FEV <- read_csv(here("ZDatasets", "FEV.csv"))
studentInfo <- read_csv(here("ZDatasets","studentinfo.csv"))
```

# 1. Layered Grammar of Graphics

Quick note: `qplot()` is deprecated in order to encourage the users to learn `ggplot()` as it makes it *easier to create complex* graphics.

## 1.1 Qplot - Some Basics

Prepare the data - all this does is it relabels the variables from 0,1 to "No", "Yes".

```{r}
# Prepare the data
Cars$Sports <- Cars$Sports %>% factor(levels=c(0,1),
                                      labels=c('No','Yes'), ordered=TRUE)
Cars$Sport_utility <- Cars$Sport_utility %>% factor(levels=c(0,1),
                                                    labels=c('No','Yes'), ordered=TRUE)
Cars$Wagon <- Cars$Wagon %>% factor(levels=c(0,1),
                                    labels=c('No','Yes'), ordered=TRUE)
Cars$Minivan <- Cars$Minivan %>% factor(levels=c(0,1),
                                        labels=c('No','Yes'), ordered=TRUE)
Cars$Pickup <- Cars$Pickup %>% factor(levels=c(0,1),
                                      labels=c('No','Yes'), ordered=TRUE)
Cars$All_wheel_drive <- Cars$All_wheel_drive %>% factor(levels=c(0,1),
                                                        labels=c('No','Yes'), ordered=TRUE)
Cars$Rear_wheel_drive <- Cars$Rear_wheel_drive %>% factor(levels=c(0,1),
                                                          labels=c('No','Yes'), ordered=TRUE)
Cars$Cylinders <- Cars$Cylinders %>% as.factor()
```

### 1.1.1 Quick `qplot()` plots

```{r}
qplot(x = Cylinders, data = Cars, geom ="bar")
```

### 1.1.2 Make a box plot

```{r}
qplot(x = Cylinders, y = Kilowatts, data = Cars, geom = "boxplot")
```

### 1.1.3 Make a scatter plot

```{r}
qplot(x = Weight, y = Economy_city, data = Cars, geom = "point")
```

### 1.1.4 Transform variables

```{r}
qplot(x = log(Weight), y = log(Economy_city), data = Cars, geom = "point")
```

### 1.1.5 Map other aesthetics

```{r}
qplot(x = log(Weight), y = log(Economy_city), data = Cars, geom = "point", colour = Cylinders, shape = Cylinders)
```

### 1.1.6 Trend lines

```{r}
qplot(x = log(Weight), y = log(Economy_city), data = Cars, geom = "point") +
  stat_smooth(method = "lm")
```

### 1.1.7 Facet

```{r}
# First group categories
Cars_filter <- Cars |> filter(Cylinders %in% c("4", "6", "8"))
qplot(x = Kilowatts, y = Retail_price, data = Cars_filter, geom = "point", facets = Cylinders ~ .) +
  stat_smooth()
```

- `Cylinders ~ .` â€“> the left-hand side of the tilde symbol refers to rows and the right-hand side to columns.
- `.` signifies that no facets will appear on that dimension. In other words, split `Cylinders` across rows.
- If we wanted to move to columns, we would use `. ~ Cylinders` or just `~Cylinders`.

## 1.2 GGPlot - Main Usage

1. Data - the dataset being visualised
2. Aesthetics (aes) - mapping data variables to visual properties
3. Geometries (geom) - the type of plot element - e.g. points, lines, bars
4. Statistics (stats) - summarise data
5. Coordinates (coord) - coordinate system, e.g. Catesian, polar
6. Facets - split data into subplots by variable
7. Scales - control mapping from data to aesthetics (color, axes, transformations)
8. Theme - control non-data elements (fonts, background, gridlines)

```{r}
# Example - ggplot2 already loaded
ggplot(data = mtcars, aes(x = wt, y = mpg, color = factor(cyl))) +  # data + aesthetics
  geom_point(size = 3) +                                            # geometry layer
  geom_smooth(method = "lm") +                                      # statistical layer
  labs(title = "MPG vs Weight by Cylinder") +                        # labels
  theme_minimal()                                                    # theme layer
```


# 2. Boxplots

Provides a quick summary of the spread, center, and skewness of categorical data. Perfect to compare one categorical variable agains a numeric one.

It shows: Central tendency (mean), Spread/ Variability (Interquartile Range), Outliers, Skewness.

```{r}
# Create a boxplot
ggplot(data = Cars_filter, aes(x=Cylinders, y=Economy_city)) +
  geom_boxplot(outlier.shape = NA) + geom_jitter(alpha = 1/5) + # Removes the outliers of the boxplot but displays the raw data values
  ylab("City Fuel Economy (km/L)") +
  ggtitle("Smaller engines have better city fuel economy") +
  stat_summary(fun.y = mean, colour = "red", shape = 17) + # Adds a summary statistic (here mean)
  theme_minimal()
```

Boxplot with a 95% confidence interval.

```{r}
g1 <- ggplot(data = FEV, aes(x=smoking, y=FEV))
g1 + geom_boxplot() + 
  stat_summary(fun.y = "mean", geom="point", colour="red") +
  stat_summary(fun.data = "mean_cl_boot", color = 'red', geom="errorbar", width=.2)
```


# 3. Scatterplot

Perfect to visualise the relationship of two numeric variables. You can easily add a linear regression line to the groups to get a sense of how the relationship changes.

```{r}
# Create a scatter plot
ggplot(data = Cars_filter, aes(x = log(Kilowatts), y=log(Economy_city), colour = Cylinders)) + #log() to reduce right-skeweness
  geom_point() + # Scatter plot
  facet_grid(~ Cylinders) + # Facet the data by Cylinders
  geom_smooth(method = "lm") + # Add a linear regression line
  theme_bw() # Black-White theme
```

# 4. Histogram

Used to visualise the distribution of a continuous (numeric) variable by showing how often values fall within specific ranges (bins). They show the shape of the data distribution, show the frequency of values, detect outliers and compare distributions.

```{r}
# Define the factors
Diamonds$cut <- factor(Diamonds$cut,
                       levels = c("Fair", "Good", "Very Good", "Premium", "Ideal"),
                       ordered = TRUE)
Diamonds$color<- factor(Diamonds$color,
                        levels=c('J','I','H','G','F','E','D'),
                        ordered=TRUE)
Diamonds$clarity<- factor(Diamonds$clarity,
                          levels=c('I1','SI2','SI1','VS2','VS1','VVS2','VVS1','IF'),
                          ordered=TRUE)
```

Create a histogram:

```{r}
p1 <- ggplot(data = Diamonds, aes(carat))
p1 + geom_histogram(colour = "#FFFFFF", fill = "#FF9643")
```


# 5. Colour in R

## 5.1 `scale_fill_manual()`

```{r}
p2 <- ggplot(data = Diamonds, aes(carat, fill = cut))
p2 + geom_density(alpha = 0.2) +
  scale_fill_manual(values = c("#9A32CD","#FF8C00","#e31a1c","#66CD00","#1C86EE"))
```

## 5.2 `scale_fill_brewer()`

```{r}
p3 <- ggplot(data = Diamonds, aes(x = color,y = price,fill=cut))
p3 + geom_boxplot() +
  scale_fill_brewer(palette = 'Blues') # Subsequential fade
```

## 5.3 `scale_colour_gradient()`

```{r}
p4 <- ggplot(Cars, aes(Kilowatts, y = Retail_price, colour = Economy_highway))
p4 + geom_point() +
  scale_colour_gradient(low = "blue", high = "red", na.value = 'green')
```

# 6. Qualitative univarate visualisations

## 6.1 Bar Chart

Data visualisation for qualitative (nominal and ordinal) data. Easier to work with when you summarise the data beforehand

```{r}
# Get data
msnbc |> head()
```

```{r}
msnbc_sum <- msnbc |> group_by(First) |> summarise(count = n())
msnbc_sum$Proportion <- msnbc_sum$count / nrow(msnbc)
msnbc_sum$Percent <- msnbc_sum$Proportion*100
msnbc_sum$First <- msnbc_sum$First |> 
  factor(levels = msnbc_sum$First[order(-msnbc_sum$count)])
msnbc_sum |> head()
```

Construct the bar chart:

```{r}
p1 <- ggplot(msnbc_sum, aes(x = First, y = Percent))
p1 + geom_bar(stat = "identity", fill = "dodgerblue3") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    title = "Unique Visits to Different MSNBC.com Landing Pages \n 28/09/1999",
    y = "Percentage of Unique Visitors",
    x = "Landing Page within MSNBC.com Domain") +
  geom_text(aes(label = round(Percent, 2)), vjust = -0.5, size = 3)
```

## 6.2 Dot Plot

```{r}
# Prepare the data
msnbc_sum$First <- factor(msnbc_sum$First, 
                          levels = msnbc_sum$First[order(msnbc_sum$count)])
p3 <- ggplot(msnbc_sum, aes(y=First, x=count))
p3 + geom_point() +
  geom_segment(aes(x=0, y=First, xend = count, yend = First), linetype = 2) +
  labs(title = "Unique Visits to Different MSNBC.com \n Landing Pages \n 28/09/1999",
       x = "No. of Unique Visitors",
       y = "Landing Page within MSNBC.com Domain") +
  geom_text(aes(label=round(count,2)), hjust = -.2,size = 3) +
  scale_x_continuous(limits = c(0,350000))
```

## 6.3 Pie chart

Pie charts have many perceptual challenges but for some reason they are really good at grabbing attention.

```{r}
# Let's filter our data
msnbc_sum_top_five <- msnbc_sum |> filter(rank(count) > 12)
# Recalculate the proportions and percentages based on the top five plots
msnbc_sum_top_five$Proportion <- msnbc_sum_top_five$count / sum(msnbc_sum_top_five$count)
msnbc_sum_top_five$Percent <- msnbc_sum_top_five$Proportion*100
msnbc_sum_top_five <- msnbc_sum_top_five |> arrange(desc(count))
msnbc_sum_top_five
```

```{r}
# Prepare the pie chart
p4 <- ggplot(msnbc_sum_top_five, aes(x=factor(1), y=count, fill = First))
p4 + geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") +
  theme(axis.ticks=element_blank(),
        axis.title=element_blank(),
        axis.text.y=element_blank(),
        axis.text.x=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank()) +
  labs(fill = "Top Five Landing Pages") +
  geom_text(aes(y = (cumsum(count)-count) +
                  (count/2),
                label=round(Percent,2), angle = 0))
```

## 6.4 Coxcomb diagram

```{r}
p6 <- ggplot(msnbc_sum_top_five, aes(x=First, y=count, fill=First))
p6 + geom_bar(stat="identity", width = 1) + coord_polar()
```

# 7. Quantitative univariate visualisation

We already covered Histogram, Boxplot & Density plot.

```{r}
# Overlaying univariate plots
Youtube_clean <- Youtube |> filter(duration > 1 & duration < 624)
p7 <- ggplot(Youtube_clean, aes(x=duration))
p7 + geom_density(fill = "dodgerblue3", alpha = 1/3) + 
  geom_histogram(colour="white",aes(duration,..density..), alpha = 1/2,bins=100) +
  geom_vline(xintercept = median(Youtube_clean$duration)) +
  annotate("text", label = "Median", x = 90, y = 0.006) +
  geom_vline(xintercept = mean(Youtube_clean$duration), linetype = 2) +
  annotate("text", label = "Mean", x=190, y = 0.004)
```

## 7.1 Violin plot with boxplot

```{r}
p8 <- ggplot(Youtube_clean, aes(x=factor(1), y=duration))
p8 + geom_violin(width=.25, fill = "grey") +
  geom_boxplot(width = .25, alpha = .25)
```

# 8. Qualitative bivariate visualisation

## 8.1 Bar chart of two variables

```{r}
p9 <- ggplot(data=Hair_Eye_Colour, aes(x=Hair, fill = Eyes))
p9 + geom_bar(position = "dodge") +
  labs(y = "Proportion within Hair Colour") +
  scale_fill_manual(values = c("#1569C7","#94703D","#566638","#6B7E47"))
```

```{r}
# Create crosstabulation
crosstab1 <- table(Hair_Eye_Colour$Hair, Hair_Eye_Colour$Eyes, dnn = c("Hair","Eyes"))
prop.table(crosstab1, 1)
```

## 8.2 Mosaic plots

```{r}
# Prepare the data
tb <- table(Hair_Eye_Colour$Hair, Hair_Eye_Colour$Eyes) |> data.frame()
colnames(tb) <- c("Hair", "Eyes", "Freq")
tb |> head()
```

Plot the mosaic plot:

```{r, warning=FALSE}
library(ggmosaic)
p10 <- ggplot(tb)
p10 + geom_mosaic(aes(x = product(Hair), weight = Freq, fill = Eyes)) +
  labs(x = "Hair Colour")
```


# 9. Quantitative bivariate visualisation

## 9.1 Scatterplot matrix

```{r}
# library(GGally)
# Output is massive
#ggpairs(Body, columns = c(3,6,7,10:19), axisLabels = "internal")
```

## 9.1 Scatter plot - `density2d`

Normal scatterplot has been covered, let's look at a density plot:

```{r}
p11 <- ggplot(data = Body, aes(x = Abdomen, y = BFP_Siri))
p11 + geom_point() + geom_density2d()
```

## 9.2 One quantitative and one qualitative variable - Side-by-side box plots

```{r}
# Order the boxplot
mpg_rank <- mpg |> group_by(class) |> summarise(med = median(cty))
mpg$class <- mpg$class |> factor(levels = mpg_rank$class[order(-mpg_rank$med)])

# Display the boxplot
p12 <- ggplot(data=mpg, aes(x=class, y=cty))
p12 + geom_boxplot() + coord_flip()
```

## 9.3 Stacked dot plot with means

```{r, warning=FALSE}
p12 + geom_dotplot(binaxis = "y", stackdir = "center", dotsize = 1/2, alpha = .25) +
  stat_summary(fun.y = "mean", geom = "point", colour = "red")
```

# 10. Multivariate data

- Mapping additional aesthetics
- Faceting
- Purpose built
- Animation

## 10.1 Using additional aesthetics

```{r}
library(gapminder)
gapminder2007 <- gapminder |> filter(year==2007)
g2 <- ggplot(gapminder2007, aes(x=gdpPercap,y=lifeExp))
g2 + geom_point(aes(size = pop, colour = continent)) +
  labs(x="GDP Per Capita", y="Life Expectancy", title="Country GDP per capita predicts life expectancy (2007)") +
  scale_size(name = "Pop Size") +
  scale_color_discrete(name = "Continent")
```

## 10.2 Faceting

`facet_grid(. ~ var)` will align facets as columns and `facet_grid(var ~ .)` as rows.

```{r}
ggplot(studentInfo, aes(x=highest_education, y=avg_grade, fill=gender)) +
  geom_boxplot() +
  labs(y="Average Grade", x="Highest Education") +
  theme(legend.title=element_blank()) + coord_flip() +
  facet_wrap(~ region)
```

