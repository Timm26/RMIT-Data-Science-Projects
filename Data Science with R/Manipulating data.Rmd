---
title: "Manipulating data"
output: html_document
---
```{r}
# Packages
library(dplyr)
library(magrittr)
library(readr)
library(openxlsx)
library(readxl)
```

```{r}
# Import some datasets
country <- read_csv(here("ZDatasets", "CountryRegionDataset.csv"))
terror  <- read_csv(here("ZDatasets", "globalterrorismdb_0718distWeek3.csv"))
starwars <- dplyr::starwars
```


# 1. {dplyr} package

- select()
- filter()
- arrange()
- mutate()
- summarise()

## 1.1 Filter data

- readr::read_excel() is faster than openxlsx::read.xlsx()
- read_excel also correctly identifies the date columns

```{r}
# Get data
flu <- read_excel(here("ZDatasets","Influenza (laboratory confirmed) Public datset 2008 to 2017-1.xlsx"), sheet = 1, skip = 1)
names(flu)
# Rename some column names
flu <- flu %<>% 
  rename(
    Week_Ending_Friday = `Week Ending (Friday)`,
    Age_group = `Age  group`,
    Indigenous_status = `Indigenous status`
  )
flu |> head()
```

```{r}
# Filter to Queensland female
flu %<>%
  filter(State == "Qld" & Gender == "Female")
flu |> head()
```

## 1.2 count() and arrange() function

```{r}
# Population count
flu |> 
  filter(Indigenous_status == "Indigenous") |> 
  count() / count(flu) * 100
```

```{r}
# Arrange()
flu |> 
  arrange(Age_group)
```

## 1.3 Create a new variable

```{r}
# Number of variables
starwars |> ncol()
```

### 1.3.1 Mutate() funtion

```{r}
# Add a variable using mutate()
starwars %<>%
  mutate(BMI = mass / (height/100)^2)
starwars[,10:15] |> head()
```

### 1.3.2 Create a new variable using case_when

```{r}
starwars %<>%
  mutate(weight_class = case_when(is.na(BMI) ~ "Unknown",
                                  BMI < 18.5 ~ "Underweight BMI",
                                  BMI >= 25 ~ "Healthy BMI",
                                  TRUE ~ "Unknown"))
starwars[,11:16] |> head()
```

```{r}
# Check any NA's
table(starwars$weight_class, useNA = "always")
```

### 1.3.3 Select() function

```{r}
starwars |> 
  select(name, mass, height, BMI, weight_class) |>
  arrange(name) |> head()
```

#### 1.3.3.1 Select statements 'contains()'

```{r}
# Filter columns that contains "ir"
starwars |> 
  select(contains("ir")) |> head()
```

#### starts_with()

```{r}
# Filter columns that start with "B" or "b"
starwars |> 
  select(starts_with("B")) |> head()
```


## 1.4 Filter and create new variables

```{r}
# Combine multiple columns
library(glue)
starwars |> 
  filter(species == "Human") |> 
  arrange(height, mass) |> 
  group_by(hair_color) |> 
  transmute(unitid = glue("{name} {hair_color} {height} {mass}")) |> 
  head()
```

## 1.5 Drop and rename variables

```{r}
# Show the current first 3 variable names of starwars
paste0("Before any change: ",names(starwars)[1:3])

# Using select to drop variables
starwars <- starwars |>  
  select(-name) |> 
  rename(Height = height, Mass = mass)
# Show changes
paste0("After any change: ",names(starwars)[1:3]) # name is gone and height and mass now as titles
```


# 2. Join, mutate and merge datasets

```{r}
# Get the data
library(nycflights13)
airlines <- nycflights13::airlines
airports <- nycflights13::airports
flights <- nycflights13::flights
planes <- nycflights13::planes
weather <- nycflights13::weather

# Identify variables
airports |> names()
```


- *Mutating join*: This group of functions add new variables to one data frame matching observations in another (inner_join, left_join, right_join, full_join)
- *Filtering joins*: This group of functions filter observations from one data frame based on whether or not they match an observation in the other table (semi_join, anti_join)
- *Set operations*: This group of functions treat observations as if they were set elements. (union, intersect, setdiff)
- *Merging datasets*: bind_rows, bind_cols

## 2.1 Mutating joins

### 2.1.1 Inner join

```{r}
inner_join_weather <- weather |> 
  inner_join(flights, by = c("year","month","day","time_hour","origin"))
inner_join_weather |> head()
```

### 2.1.2 Left join

```{r}
terror |> 
  left_join(country, by = c("country_txt" = "Country")) |> head()
```


## 2.2 Filtering joins

## 2.3 Set operations

### 2.3.1 Intersect

Filtering for intersecting columns.

```{r}
intersect(airlines |> names(),
          airports |> names())
```

## 2.4 Merging datasets

```{r}
# Get data
auseq <- read.csv(here("ZDatasets","AusEQ2010.csv"))
quakes <- datasets::quakes
# Prepare the quakes dataset for merging
quakes <- quakes |>  select(-stations) |> rename(latitude= lat, longitude = long)
auseq <- auseq |>  select(latitude, longitude, depth, mag)
auseq |> head()
quakes |> tail()
```

### 2.4.1 Using bind_rows()

Adds the rows of dataset 2 to dataset 1 while matching the columns. If columns don't exist it will fill them with NaN.

```{r}
# Merging using bind_rows
comb_quakes <- bind_rows(auseq, quakes)
comb_quakes |> head()
comb_quakes |> tail()
```

# 3. String Manipulation functions

## 3.1 Create a variable using concatentation

- chartr()
- gsub()

### 3.1.1 Single character replacement

```{r}
# chartr to replace a single character
x <- "This is A string"
chartr(old = "A", new = 'a',x)
chartr(old = "is", new = "as", x) # replaces each i with a and each s with s
```

Changing all flight number 1545 to 1595:

```{r}
flights$flight |> head()
flights$flight <- flights$flight |> gsub(pattern = 1545, replacement = 1595) |> as.numeric() # gsub will change the type to an object
flights$flight |> head()
```

## 3.2 Replace character variables

- substr()
- strsplit()

### 3.2.1 Using substr()

Replaces a pre-defined sequence of characters.

```{r}
alphabet <- paste(LETTERS, collapse = "")
alphabet
```

```{r}
# Extract the 18th to 24th character
substr(alphabet, start = 18, stop = 24) <- "RRRRRR"
alphabet
```

Calling `substr()` on a dataframe column. Creating `sex` abbreviations.

```{r}
starwars$sex_short <- substr(starwars$sex, start = 1, stop=1)
starwars |> select(sex, sex_short) |> head()
```


# 4. Summarise statistics

More and deeper exposure to dpylr's `summarise()` function in R. It produces summary statistics of an entire dataset and works great in combination with `group_by()`.

Useful functions that can be used inside `summarise()`: `min()`, `max()`, `mean()`, `median()`, `sum()`, `var()`, `sd()`, `first()`, `last()`, `nth()`, `n()`, `n_distinct()`.

All functions take a vector of values and return a single summary value.

```{r}
# Mean delay
flights |> 
  summarise(delay = mean(dep_delay, na.rm = TRUE))
```

```{r}
# Summary statistics grouped by factor or character
flights |> 
  group_by(dest) |> 
  summarise(mean_delay = mean(dep_delay, na.rm = TRUE), 
            flights = n()) |> head() # Delay by destination
```

The below creates summary statistics for magnitude, database `quakes`.

```{r}
magnitude_stats <- quakes %>% 
  summarise(Min_Magnitude = min(mag, na.rm = TRUE), 
            Q1_Magnitude = quantile(mag, probs = 0.25, na.rm = TRUE), 
            Median_Magnitude = median(mag, na.rm = TRUE), 
            Q3_Magnitude = quantile(mag, probs = 0.75, na.rm = TRUE), 
            Max_Magnitude = max(mag, na.rm = TRUE), 
            Mean_Magnitude = mean(mag, na.rm = TRUE), 
            SD_Magnitude = sd(mag, na.rm = TRUE), 
            Missing_Magnitude = sum(is.na(mag)), 
            n = n())
magnitude_stats
```

Getting the total number of killed or injured:

```{r}
# Show total killed or injured
terror |> 
  group_by(country_txt) |> 
  summarise(total_killed = sum(nkill, na.rm = TRUE),
                    total_wounded = sum(nwound, na.rm = TRUE)) |> 
  arrange(desc(total_killed)) |> head()
```


# 5. Manipulating time and date

Main packages: `{stringr}` `{lubridate}`.

```{r}
library(stringr)
library(lubridate)
```


## 5.1 Get time and date

Accessing current time and date: `Sys.timezone()`, `Sys.Date`, `Sys.time()`

```{r}
# Get time zone information
Sys.timezone()
# Get date information
Sys.Date()
# Get time
Sys.time()
# Get current time using lubridate
lubridate::now()
```

{lubridate} can automatically recognise the common separators used when recording dates: `now()`, `ymd()`, `ydm()`, `mdy()`, `dmy()`, `hm()`, `ymd_hms()`

```{r}
z <- c("08.03.2018", "29062017", "23/03/2016", "30-01-2018")
z <- dmy(z)
z
```

## 5.2 Extract and manipulate date variables

```{r}
# Data
flights <- nycflights13::flights
flights_new <- flights |> 
  select(year, month, day, hour, minute)
flights_new |> head()
```

Use make_date() and make_datetime() for date-times:

```{r}
# make_datetime()
flights_new %<>%
  mutate(departure = make_datetime(year, month, day, hour, minute))
flights_new |> head()
```

To extract the year or month, wday:

```{r}
# Extract the year
flights_new$departure |> year() |> head()
# Extract the month
flights_new$departure |> month(label = TRUE, abbr = TRUE) |> head()
# Extract the weekday
flights_new$departure |> wday() |> head()
```
















































